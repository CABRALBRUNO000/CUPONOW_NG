import { Injectable } from '@angular/core';
import { ChatOpenAI } from '@langchain/openai';
import { HumanMessage, SystemMessage } from '@langchain/core/messages';
import { Message } from '../models/message.model';
import { environment } from '../../environments/environment';
import { PromptTemplate } from '@langchain/core/prompts';
import { JsonOutputParser } from '@langchain/core/output_parsers';
import { RunnableSequence } from '@langchain/core/runnables';
import { Offer } from '../models/offer.model';
interface ChatResponse {
  message: string;
  products: Offer[];
}
@Injectable({
  providedIn: 'root'
})
export class AiChatService {
  private chatModel: ChatOpenAI;
  private systemMessage: SystemMessage;

  constructor() {
    this.chatModel = new ChatOpenAI({
      openAIApiKey: environment.openAiKey,
      temperature: 0.7,
      modelName: 'gpt-3.5-turbo-1106'
    });

    this.systemMessage = new SystemMessage(
      `Você é um assistente especializado em encontrar e recomendar cupons de desconto. 
      Responda a perguntas gerais de forma amigável. 
      Quando o usuário solicitar ofertas, você DEVE retornar uma resposta no seguinte formato JSON:
      {
          "message": "sua mensagem amigável para o usuário",
          "products": [
              {
                "id": "id do produto",
                "product": "nome do produto",
                "description": "descricao do produto",
                "imageUrl": "url da imagem do produto",
                "originalPrice": "preco original do produto",
                "discountedPrice": "preco com desconto do produto"
              }
          ]
      }
      Sempre inclua todos os campos necessários para cada produto.
      Mantenha este formato JSON para garantir que os produtos sejam exibidos corretamente.
      `
    );
    
  }

  async sendMessage(message: string): Promise<ChatResponse> {
    try {
      const response = await this.chatModel.invoke([
        this.systemMessage,
        new HumanMessage(
          `Busque ofertas relacionadas a: ${message}. 
           quando necessário Retorne apenas o JSON com a oferta mais relevante.`
        )
      ]);
      
      const parsedResponse = JSON.parse(response.content as string);
      return {
        message: parsedResponse.message,
        products: parsedResponse.products
      };
    } catch (error) {
      console.error('Erro ao processar mensagem:', error);
      return {
        message: 'Desculpe, não consegui processar sua solicitação.',
        products: []
      };
    }
  }

  
}
